{{/* 阅读进度条 */}}
<div class="reading-progress" id="reading-progress"></div>

{{/* 返回顶部按钮 */}}
<button class="back-to-top" id="back-to-top" aria-label="返回顶部">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
  </svg>
</button>

{{/* 图片灯箱 */}}
<div class="lightbox" id="lightbox" aria-hidden="true">
  <button class="lightbox-close" aria-label="关闭">&times;</button>
  <img class="lightbox-image" id="lightbox-image" src="" alt="" />
  <div class="lightbox-caption" id="lightbox-caption"></div>
</div>

<script>
(function() {
  'use strict';

  // ============ 常量和工具函数 ============
  var THEME_KEY = 'theme-preference';
  var COPY_ICON = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
  var CHECK_ICON = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';

  // ============ 主题切换 ============
  function getPreferredTheme() {
    var saved = localStorage.getItem(THEME_KEY);
    return saved || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  }

  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(THEME_KEY, theme);
  }

  // 初始化主题
  setTheme(getPreferredTheme());

  // 监听系统主题变化
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
    if (!localStorage.getItem(THEME_KEY)) {
      setTheme(e.matches ? 'dark' : 'light');
    }
  });

  // ============ 滚动相关功能 ============
  var backToTop = document.getElementById('back-to-top');
  var progressBar = document.getElementById('reading-progress');
  var ticking = false;

  function updateScrollUI() {
    var scrollTop = window.scrollY;
    var docHeight = document.documentElement.scrollHeight - window.innerHeight;

    // 阅读进度条
    if (progressBar && docHeight > 0) {
      progressBar.style.width = (scrollTop / docHeight * 100) + '%';
    }

    // 返回顶部按钮
    if (backToTop) {
      backToTop.classList.toggle('visible', scrollTop > 300);
    }
  }

  window.addEventListener('scroll', function() {
    if (!ticking) {
      requestAnimationFrame(function() {
        updateScrollUI();
        ticking = false;
      });
      ticking = true;
    }
  }, { passive: true });

  if (backToTop) {
    backToTop.addEventListener('click', function() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  }

  // ============ DOMContentLoaded 统一处理 ============
  document.addEventListener('DOMContentLoaded', function() {
    updateScrollUI();

    // 主题切换按钮
    var toggleBtn = document.getElementById('theme-toggle');
    if (toggleBtn) {
      toggleBtn.addEventListener('click', function() {
        var current = document.documentElement.getAttribute('data-theme');
        setTheme(current === 'dark' ? 'light' : 'dark');
      });
    }

    // 代码复制按钮
    document.querySelectorAll('pre').forEach(function(pre) {
      var wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';
      pre.parentNode.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      var copyBtn = document.createElement('button');
      copyBtn.className = 'copy-code-btn';
      copyBtn.innerHTML = COPY_ICON;
      copyBtn.title = '复制代码';
      wrapper.appendChild(copyBtn);

      copyBtn.addEventListener('click', function() {
        var code = pre.querySelector('code') || pre;
        navigator.clipboard.writeText(code.textContent).then(function() {
          copyBtn.innerHTML = CHECK_ICON;
          copyBtn.classList.add('copied');
          setTimeout(function() {
            copyBtn.innerHTML = COPY_ICON;
            copyBtn.classList.remove('copied');
          }, 2000);
        });
      });
    });

    // 图片灯箱
    var lightbox = document.getElementById('lightbox');
    var lightboxImage = document.getElementById('lightbox-image');
    var lightboxCaption = document.getElementById('lightbox-caption');

    if (lightbox) {
      var article = document.getElementById('article') || document.querySelector('.post-content') || document.querySelector('article');
      if (article) {
        article.querySelectorAll('img').forEach(function(img) {
          img.style.cursor = 'zoom-in';
          img.addEventListener('click', function() {
            lightboxImage.src = img.src;
            lightboxCaption.textContent = img.alt || '';
            lightbox.classList.add('active');
            lightbox.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
          });
        });
      }

      function closeLightbox() {
        lightbox.classList.remove('active');
        lightbox.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }

      lightbox.addEventListener('click', function(e) {
        if (e.target === lightbox || e.target.classList.contains('lightbox-close')) {
          closeLightbox();
        }
      });

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && lightbox.classList.contains('active')) {
          closeLightbox();
        }
      });
    }

    // TOC 目录高亮
    var toc = document.getElementById('toc');
    if (toc) {
      var tocLinks = toc.querySelectorAll('a');
      var headings = [];

      tocLinks.forEach(function(link) {
        var id = link.getAttribute('href').slice(1);
        var heading = document.getElementById(id);
        if (heading) headings.push({ link: link, heading: heading });
      });

      if (headings.length > 0) {
        var tocTicking = false;

        function updateTocHighlight() {
          var scrollTop = window.scrollY + 100;
          var current = null;

          headings.forEach(function(item) {
            if (item.heading.offsetTop <= scrollTop) current = item;
          });

          tocLinks.forEach(function(link) { link.classList.remove('active'); });
          if (current) current.link.classList.add('active');
        }

        window.addEventListener('scroll', function() {
          if (!tocTicking) {
            requestAnimationFrame(function() {
              updateTocHighlight();
              tocTicking = false;
            });
            tocTicking = true;
          }
        }, { passive: true });

        tocLinks.forEach(function(link) {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            var target = document.getElementById(link.getAttribute('href').slice(1));
            if (target) {
              window.scrollTo({ top: target.offsetTop - 80, behavior: 'smooth' });
            }
          });
        });

        updateTocHighlight();
      }
    }
  });

  // ============ Service Worker 注册 ============
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/sw.js').catch(function() {});
    });
  }
})();
</script>
